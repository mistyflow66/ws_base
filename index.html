// --- é—œéµè¨­å®šå€ ---
const GAS_URL = "https://script.google.com/macros/s/AKfycbySPYLiPf6pUhZqbHMSK2z2eYtrzVWrPUweojAoCG8_15IrxQH0dhTOiXp1gf58dpiEQg/exec"; 
const ADMIN_KEY_VAL = (123 * 914 + 39).toString();
const STORAGE_KEY = "wish_stay_admin_pwd";

const PRICE_MAP = {      
  '201': { weekday: { 1: 1900 }, weekend: { 1: 2200 }, cny: { 1: 2900 } },      
  '202': { weekday: { 1: 2400, 2: 2600 }, weekend: { 1: 2600, 2: 2800 }, cny: { 1: 5600, 2: 6000 } },      
  '301': { weekday: { 1: 3500, 2: 4500, 3: 5000, 4: 5500 }, weekend: { 1: 3800, 2: 4800, 3: 5300, 4: 5800 }, cny: { 1: 6000, 2: 7000, 3: 8000, 4: 9000 } }      
};

// --- æ¨¡æ¿è³‡æ–™åº« (å·²æ›´æ–°ç‚ºæœ€æ–°æ–‡æ¡ˆ) ---
const TPL_DATA = [      
  { cat: 'è¨‚æˆ¿', title: 'æœ‰ç©ºæˆ¿å›è¦†(å«ä»‹ç´¹)', content: (d) => `ğŸ‘‹æ‚¨å¥½ï½ç…¦é¡˜æ°‘å®¿ ${d} æœ‰ç©ºæˆ¿ï¼Œæ¯é–“æˆ¿éƒ½æœ‰é™½å°\nå¯¬æ•å®¢å»³å‚™æœ‰ï¼š\nâœ…é›»å‹•éº»å°‡æ¡Œâœ…è—èŠ½éº¥å…‹é¢¨éŸ³éŸ¿âœ…æ¡ŒéŠâœ…å»šæˆ¿å¯ç…®ç«é‹ï¼Œå¤§é•·æ¡ŒåŒæ¨‚è‡ªåœ¨è¼•é¬†\nè»Šåº«æœ€å¤šå¯åœæ”¾3è¼›è»Š\nç§è¨Šè¨‚æˆ¿å¯äº«å„ªæƒ ï½\næ°‘å®¿è¨­æ–½å¯åƒè€ƒå®˜ç¶²ï¼šwishstaybnb.com` },      
  { cat: 'è¨‚æˆ¿', title: 'åŒ¯æ¬¾è³‡è¨Š', content: (d,p,dep) => `ä¸­è¯éƒµæ”¿ï¼ˆä»£è™Ÿ700ï¼‰\nå¸³è™Ÿï¼š0111334-0036797\næˆ¶åï¼šæ—å¥å»·\néœ€éº»ç…©æ‚¨æ–¼ 24 å°æ™‚å…§åŒ¯å…¥è¨‚é‡‘ $${dep}ï¼Œæ ¸å°å¾Œå³å®Œæˆé å®šã€‚` },      
  { cat: 'è¨‚æˆ¿', title: 'è©¢å•è¨­å‚™éœ€æ±‚', content: () => `éœ€è¦å¹«æ‚¨æº–å‚™é›»å‹•éº»å°‡æ¡Œã€è—èŠ½éº¥å…‹é¢¨éŸ³ç®±ã€è·³è·³é¦¬å—ï¼Ÿ` },
  { cat: 'å…¥ä½', title: 'å…¥ä½å®Œæ•´æ‰“åŒ…(å«è¦å‰‡)', content: (d,p) => `ç…¦é¡˜å°å¹«æ‰‹å…ˆä»‹ç´¹ï¼š\nğŸŒŸé€™é‚Šå…ˆçµ¦æ‚¨ä»Šæ—¥å¤§é–€å¯†ç¢¼ï¼š${p}\nğŸ”“é–‹é–€æ–¹æ³•ï¼š\nï¼ˆ1ï¼‰å¾å¤–é–‹é–€ï¼šæ‰‹æŒè§¸ç¢°è¢å¹•ï¼ŒæŒ‰éµäº®èµ·å¾Œè¼¸å…¥\nï¼ˆ2ï¼‰å¾è£¡é¢å‡ºå»ï¼šæŒ‰ä¸‹å®‰å…¨éˆ•ã€æ‰‹æŠŠåŒæ™‚ä¸‹å£“å³å¯é–‹é–€\n\nğŸŒŸæˆ¿é–“é‘°åŒ™é…å‚™åœ¨-é›»è¦–æ«ƒæ—é‘°åŒ™æ¶ï¼Œæ­¡è¿ä½¿ç”¨\néš”å¤©11é»é€€æˆ¿æ™‚ï¼Œé‘°åŒ™æ”¾å›æ¶ä¸Šï¼Œå›å‚³ç…§ç‰‡å³åšå¥½é€€æˆ¿æ‰‹çºŒå–”ï½\n\nğŸŒŸæ°‘å®¿æ‹–é‹æ¯ä¸€çµ„å®¢äººé›¢é–‹å¾Œéƒ½æ¸…æ´—éï¼Œæ¯ä¸€çµ„å®¢äººéƒ½æ˜¯å°ˆå±¬çš„å®¤å…§æ‹–é‹ï¼Œè«‹æ‚¨æ”¾å¿ƒä½¿ç”¨ï½\n\nğŸŒŸæ°‘å®¿å®¤å…§å…¨é¢ç¦è¸ï¼Œè‹¥æœ‰éœ€è¦å¸è¸çš„æœ‹å‹ï¼Œæˆ‘å€‘æ¯å€‹é™½å°å’Œè»Šåº«éƒ½å‚™æœ‰ç…™ç°ç¼¸ï¼Œè¬è¬æ‚¨ğŸ™\n\nğŸŒŸæ°‘å®¿å‚™æœ‰å¤§ã€å°æ¯›å·¾ã€æ¼±å£æ¯ã€æ²æµ´ä¹³å’Œæ´—é«®ç²¾æ˜¯ç”¨-æ²™å¨éš†ç³»åˆ—ï¼Œä¸¦å‚™æœ‰æ—‹è½‰å¼æŒ‰æ‘©è“®è“¬é ­å’Œå¹é¢¨æ©Ÿï¼Œèˆ’ç·©æ‚¨æ—…é€”çš„ç–²æ†Š\n\nğŸŒŸå§å°ä¸Šé¢çš„é£²å“å’Œé›¶é£Ÿã€ç¤¦æ³‰æ°´æ˜¯ç‚ºæ‚¨å€‘åšæº–å‚™ï¼Œè«‹è‡ªè¡Œå–ç”¨\n\nğŸŒŸæº«é¦¨æé†’ï¼Œç¾åœ¨æ°‘å®¿ä¸èƒ½ä¸»å‹•æä¾›ç‰™åˆ·ç‰™è†ä¸€æ¬¡æ€§ç”¨å…·ï¼Œè‹¥çœŸçš„æ²’æœ‰å¸¶ï¼Œè«‹å‘ŠçŸ¥\n\nç…¦é¡˜æ°‘å®¿ç¥æ‚¨å…¥ä½æ„‰å¿«â˜ºï¸` },
  { cat: 'è¨­æ–½', title: 'å¤§é–€é–‹é–å½±ç‰‡', content: () => `ğŸ”’å¤§é–€å¯†ç¢¼é–‹é–\næ‰‹æ“ºä¸Šå¯†ç¢¼ç›¤æ„Ÿæ‡‰åˆ°å°±æœƒäº®å‡ºä¾†ï¼Œè¼¸å…¥å¯†ç¢¼å¾ŒæŒ‰*å­—éµé–‹é–€ã€‚\nè‹¥å¤§é–€ä¹…æœªé—œä¸Šï¼Œé›»å­é–æœƒç™¼å‡ºå—¶å—¶è²ï¼Œå½±ç‰‡å¾Œæ®µæœ‰ç¤ºç¯„å¦‚ä½•è§£é™¤\nhttps://youtu.be/zAHONO_SOAc` },
  { cat: 'è¨­æ–½', title: 'éº¥å…‹é¢¨æ•™å­¸', content: () => `ğŸ¤è—ç‰™éº¥å…‹é¢¨éŸ³éŸ¿ä½¿ç”¨èªªæ˜ï¼š\nhttps://m.youtube.com/shorts/8LMhA15R870` },
  { cat: 'è¨­æ–½', title: 'å°ç®¡å®¶æº«é¦¨æé†’', content: () => `ğŸ¢ç…¦é¡˜å°ç®¡å®¶æº«é¦¨æé†’ï¼š\n1. è«‹æ–¼9:00å‰çµæŸå®¤å¤–çƒ¤è‚‰æ´»å‹•ï¼Œå¯æŠŠçƒ¤å¥½é£Ÿæç§»è‡³å®¤å…§ä¸¦é—œä¸Šå¤§é–€äº«ç”¨èšæœƒâ˜ºï¸\n2. éº¥å…‹é¢¨éŸ³éŸ¿-å”±åˆ°10:00å‰ï¼Œå¾ŒçºŒå¯é€²è¡Œæ¡ŒéŠå’Œé›»å‹•éº»å°‡åŒæ¨‚å–”ï¼\n3. æ°‘å®¿å®¤å…§å…¨é¢ç¦è¸ï¼Œè‹¥éœ€è¦å¸è¸æˆ‘å€‘æ¯é–“æˆ¿é–“å¤–é™½å°éƒ½å‚™æœ‰ç…™ç°ç¼¸\nï½ç…¦é¡˜æ°‘å®¿æ„Ÿè¬æ‚¨çš„é…åˆï½` },
  { cat: 'çƒ¤è‚‰', title: 'ä»£è¨‚é£Ÿææµç¨‹', content: () => `ä»¥ä¸‹å‘æ‚¨èªªæ˜ä»£è¨‚çƒ¤è‚‰é£Ÿæçš„ç›¸é—œæµç¨‹ï¼š\n1. ç¢ºèªåŒ¯æ¬¾å¾Œï¼Œæˆ‘å€‘å°‡ç«‹å³ç‚ºæ‚¨é€²è¡Œä»£è¨‚æœå‹™ã€‚\n2. çƒ¤è‚‰é£Ÿæå°‡ç”±å®…é…å…¬å¸é…é€ã€‚å»ºè­°ä¸­åˆå‰é€é”ï¼Œä¸¦ä¿ç•™è¶³å¤ é€€å†°æ™‚é–“ã€‚\n3. è²¨ç‰©æŠµé”å¾Œï¼Œæ°‘å®¿æœƒå…ˆå”åŠ©é–‹ç®±æª¢æŸ¥å“é …ã€æ•¸é‡ã€é‡é‡ã€‚\n4. å®Œæˆæª¢æŸ¥å¾Œï¼Œæˆ‘å€‘æœƒå°‡ç¾å ´ç…§ç‰‡å›å‚³çµ¦æ‚¨ç¢ºèªã€‚\næ„Ÿè¬æ‚¨çš„é…åˆèˆ‡æ”¯æŒï¼` },
  { cat: 'å‘¨é‚Š', title: 'è¶…å•†èˆ‡ç”Ÿæ´»æ©Ÿèƒ½', content: () => `èµ°è·¯5åˆ†é˜å¯åˆ°7-11å’Œç¾å»‰ç¤¾ï¼Œé‚„æœ‰æ—©åˆé¤åº—\n7-11ï¼šhttps://maps.app.goo.gl/uskg6orv7dVas2eb7\nç¾è¯ç¤¾ï¼šhttps://maps.app.goo.gl/LNYRJGaVaj8GNxAy7` },      
  { cat: 'å‘¨é‚Š', title: 'ç¾é£Ÿèˆ‡é˜¿ä¿¡å¿«ç‚’', content: () => `ğŸš—æ°‘å®¿é™„è¿‘çš„æ™¯é»åŠäº¤é€šï¼š\nhttps://wishstaybnb.com/transportation\n#æ°‘å®¿å¤–é¢èµ°è·¯1åˆ†é˜æœ‰ä¸€å€‹å…¬åœ’å¯æ´»å‹•\n#éš”å£é˜¿ä¿¡å¿«ç‚’(èµ°è·¯2åˆ†é˜)å ±-ç…¦é¡˜æ°‘å®¿ï¼Œå¯æ‰“9.5æŠ˜ï¼\nhttps://maps.app.goo.gl/P3wgTe4HAHboXiYy9` },
  { cat: 'å‘¨é‚Š', title: 'æ™¯é»èˆ‡æ­¥é“æ¨è–¦', content: () => `ğŸŒŸåˆ†äº«æ°‘å®¿é™„è¿‘æ™¯é»åƒè€ƒï¼š\nå®‰è¾²æºªã€è½ç¾½æ¾ã€æ¸…æ°´åœ°ç†±ã€å¤ªå¹³å±±ã€é•·åŸ¤æ¹–ç²¾éˆæ‘ã€å¼µç¾é˜¿å¬¤è¾²å ´ã€æ¢…èŠ±æ¹–ã€ç¾…æ±å¤œå¸‚ã€‚\n\nğŸ‘£æ¨è–¦æ­¥é“ï¼š\nä»å±±æ­¥é“ï¼šhttps://maps.app.goo.gl/C9XisDS8qaQax11q6\nä¸‰æ¸…å®®æ­¥é“ï¼šhttps://maps.app.goo.gl/rmyyNfcdFHc8YdbX6` },
  { cat: 'é€€æˆ¿', title: 'ä½å®¿è³‡æ–™è¡¨', content: () => `éº»ç…©æ‚¨âœï¸ä½å®¿è³‡æ–™\nï¼ˆä¸€äººä»£è¡¨å¡«å¯«å³å¯ï¼Œè¬è¬ï¼ï¼‰\nå§“åï¼š\nå‡ºç”Ÿå¹´æœˆï¼š\nèº«åˆ†è­‰è™Ÿï¼š\nä½å€ï¼š\né›»è©±ï¼š` },
  { cat: 'é€€æˆ¿', title: 'äº”æ˜Ÿå¥½è©•é€£çµ', content: () => `æœ‰ç©ºæ­¡è¿å¹«æ‚¨æˆ‘å€‘ç•™è¨€+5æ˜Ÿå¥½è©•ï¼Œæ‚¨çš„è‚¯å®šæ˜¯æˆ‘å€‘å‰é€²çš„å‹•åŠ›ï¼ç…¦é¡˜æ°‘å®¿æ„Ÿè¬æ‚¨ğŸ’•\nhttps://maps.app.goo.gl/vcoPQQuMRaME1rpY6` }
];      

let globalOrderData = [];
let currentViewDate = new Date();

// --- åˆå§‹åŒ–èˆ‡å¯†ç¢¼è¨˜æ†¶ ---
window.onload = () => { 
    updateAll(); 
    const savedKey = localStorage.getItem(STORAGE_KEY);
    if(savedKey) {
        document.getElementById('admin-key').value = savedKey;
        fetchOrders(); 
    }
};

// --- é€šç”¨åŠŸèƒ½ ---
function switchPage(id, e) {
    document.querySelectorAll('.page, .tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(e) e.currentTarget.classList.add('active');
}

function showLoading(show) {
    document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
}

function toggleAccordion(contentId, iconId) {
    const c = document.getElementById(contentId);
    c.classList.toggle('active');
    document.getElementById(iconId).innerText = c.classList.contains('active') ? 'â–²' : 'â–¼';
}

function updateAll() { updateTpl(); buildPackage(); }

// --- æ¨¡æ¿é‚è¼¯ ---
function updateTpl(filter = 'all') {
    const d = document.getElementById('v-date').value || "____";
    const p = document.getElementById('v-pwd').value || "____";
    const dep = document.getElementById('v-dep').value || "____";
    const list = document.getElementById('tpl-list');
    list.innerHTML = '';
    TPL_DATA.filter(i => filter === 'all' || i.cat === filter).forEach((item, i) => {
        const box = document.createElement('div'); box.className = 'card';
        box.innerHTML = `<h3>[${item.cat}] ${item.title}</h3><div class="preview-area" id="t-${i}">${item.content(d,p,dep)}</div><button class="copy-btn" onclick="copyText('t-${i}', event)">è¤‡è£½</button>`;
        list.appendChild(box);
    });
}

function filterCat(cat, e) {
    document.querySelectorAll('.cat-tag').forEach(el => el.classList.remove('active'));
    if(e) e.currentTarget.classList.add('active');
    updateTpl(cat);
}

function buildPackage() {
    const d = document.getElementById('v-date').value || "ä»Šå¤©";
    const p = document.getElementById('v-pwd').value || "____";
    let pkg = `ğŸ‘‹ æ‚¨å¥½ï¼ç…¦é¡˜å°å¹«æ‰‹ç‚ºæ‚¨æº–å‚™å…¥ä½è³‡è¨Š (${d})ï¼š\n\n`;
    if(document.getElementById('c-basic').checked) pkg += `ğŸŒŸ å¤§é–€å¯†ç¢¼ï¼š${p}\nğŸ”“ é–‹é–€ï¼šæ‰‹æŒè§¸ç¢°è¢å¹•äº®èµ·å¾Œè¼¸å…¥å¯†ç¢¼æŒ‰*\nğŸ”‘ é‘°åŒ™åœ¨é›»è¦–æ«ƒæ—ï¼Œé€€æˆ¿æ”¾å›å³å¯ã€‚\n----------------\n`;
    if(document.getElementById('c-amenity').checked) pkg += `ğŸ› å‚™å“ï¼šå¤§å°æ¯›å·¾ã€æ²™å¨éš†æ´—æ²ï¼Œå§å°é£²å“å…è²»ã€‚\nâš ï¸ ä¸ä¸»å‹•æä¾›ç‰™åˆ·ç‰™è†ï¼Œè«‹çŸ¥æ‚‰ã€‚\n----------------\n`;
    if(document.getElementById('c-sing').checked) pkg += `ğŸ¤ å”±æ­Œï¼šè«‹æ–¼ 10:00 å‰çµæŸï¼Œå½±ç‰‡æ•™å­¸ï¼šhttps://m.youtube.com/shorts/8LMhA15R870\n----------------\n`;
    if(document.getElementById('c-nearby').checked) pkg += `ğŸ± ç¾é£Ÿï¼šé˜¿ä¿¡å¿«ç‚’å ±ã€Œç…¦é¡˜ã€äº« 9.5 æŠ˜ã€‚\n----------------\n`;
    if(document.getElementById('c-spot').checked) pkg += `â›°ï¸ æ¨è–¦ï¼šä»å±±æ­¥é“ã€æ¸…æ°´åœ°ç†±ã€å¼µç¾é˜¿å¬¤è¾²å ´ã€‚\n----------------\n`;
    if(document.getElementById('c-form').checked) pkg += `âœï¸ ä½å®¿è³‡æ–™ï¼šå§“åã€ç”Ÿæ—¥ã€èº«åˆ†è­‰è™Ÿã€ä½å€ã€é›»è©±ã€‚\n----------------\n`;
    pkg += `ç¥æ‚¨å…¥ä½æ„‰å¿«ï¼â˜ºï¸`;
    document.getElementById('pkg-preview').innerText = pkg;
}

// --- å ±åƒ¹ç¥å™¨ ---
function updatePlaceholders() {
    const s = document.getElementById('m-season').value;
    document.getElementById('p-201').placeholder = PRICE_MAP['201'][s][1];
    document.getElementById('p-202').placeholder = PRICE_MAP['202'][s][1];
    document.getElementById('p-301').placeholder = PRICE_MAP['301'][s][1];
    runManualCalc();
}

function runManualCalc() {
    const s = document.getElementById('m-season').value;
    const rooms = ['201','202','301'];
    let totalBT = 0;
    rooms.forEach(rid => {
        const b = parseInt(document.getElementById('m-'+rid).value);
        if(b > 0) {
            const inputVal = document.getElementById('p-'+rid).value;
            const placeholderVal = document.getElementById('p-'+rid).placeholder;
            const finalPrice = inputVal ? parseFloat(inputVal) : parseFloat(placeholderVal);
            // è‹¥æ‰‹å‹•è¼¸å…¥åƒ¹æ ¼ï¼Œç›´æ¥åŠ ä¸Šå»ï¼›å¦å‰‡ä¾åºŠæ•¸æŸ¥è¡¨
            totalBT += inputVal ? finalPrice : PRICE_MAP[rid][s][b];
        }
    });
    const priv = Math.ceil((totalBT * 0.88 * 1.03) / 10) * 10;
    document.getElementById('calc-result').innerHTML = `
        <div class="card">
            <div class="highlight">Booking ç¸½åƒ¹ï¼š$${totalBT.toLocaleString()}</div>
            <div class="private-price">ç§è¨Šå„ªæƒ åƒ¹ï¼š$${priv.toLocaleString()}</div>
            <div class="preview-area" id="p-res" style="margin-top:10px;">ğŸ‘‹æ‚¨å¥½ï½ç…¦é¡˜æ°‘å®¿æœ‰ç©ºæˆ¿ï¼Œç§è¨Šè¨‚æˆ¿å„ªæƒ åƒ¹ï¼š$${priv.toLocaleString()}</div>
            <button class="copy-btn" onclick="copyText('p-res', event)">è¤‡è£½å ±åƒ¹</button>
        </div>`;
}

// --- è¨‚å–®èˆ‡ GAS é€šè¨Š ---
async function fetchOrders() {
    const key = document.getElementById('admin-key').value;
    if(!key) return;
    showLoading(true);
    try {
        const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "read", key: key }) });
        const data = await res.json();
        if(data && Array.isArray(data)) {
            globalOrderData = data;
            localStorage.setItem(STORAGE_KEY, key);
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('order-content').style.display = 'block';
            renderOrderList();
        }
    } catch(e) { alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥é‡‘é‘°æˆ–ç¶²è·¯"); }
    finally { showLoading(false); }
}

async function addOrder() {
    const key = document.getElementById('admin-key').value;
    const total = parseFloat(document.getElementById('o-total').value) || 0;
    const dep = parseFloat(document.getElementById('o-dep').value) || 0;
    const data = {
        action: "add", key: key,
        name: document.getElementById('o-name').value, date: document.getElementById('o-date').value,
        source: document.getElementById('o-source').value, guests: document.getElementById('o-guests').value,
        rooms: document.getElementById('o-rooms').value, total: total, dep: dep, bal: total - dep
    };
    showLoading(true);
    try {
        await fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) });
        alert("å„²å­˜æˆåŠŸï¼"); fetchOrders();
    } catch(e) { alert("å„²å­˜å¤±æ•—"); }
    finally { showLoading(false); }
}

// --- è¦–åœ–ç®¡ç† ---
function switchOrderView(view) {
    const isCal = view === 'calendar';
    document.getElementById('calendar-grid').style.display = isCal ? 'grid' : 'none';
    document.getElementById('order-list').style.display = isCal ? 'none' : 'block';
    document.getElementById('btn-view-cal').classList.toggle('active', isCal);
    document.getElementById('btn-view-list').classList.toggle('active', !isCal);
}

function renderOrderList() {
    const year = currentViewDate.getFullYear();
    const month = currentViewDate.getMonth();
    const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
    document.getElementById('cal-month-title').innerText = `${year}å¹´ ${month + 1}æœˆ`;
    const mData = globalOrderData.filter(r => r[3] && r[3].includes(monthStr));
    
    renderCalendar(year, month, mData);
    
    const orderListEl = document.getElementById('order-list');
    orderListEl.innerHTML = '';
    mData.forEach((r, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.style.position = 'relative';
        card.innerHTML = `<span class="source-tag ${r[1]==='Booking'?'tag-booking':'tag-line'}">${r[1]}</span>
            <b>${r[3].slice(8)}æ—¥ | ${r[2]}</b><br>
            <small>äººæ•¸:${r[5]} / å°¾æ¬¾:$${r[9]}</small>`;
        card.onclick = () => showOrderDetail(r);
        orderListEl.appendChild(card);
    });
    
    updateStatistics(mData);
    calculateFinance(mData);
}

function renderCalendar(year, month, mData) {
    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = '';
    const weeks = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    weeks.forEach(w => grid.innerHTML += `<div class="cal-day cal-header">${w}</div>`);
    
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="cal-day"></div>`;
    
    for (let day = 1; day <= lastDate; day++) {
        const fullDate = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        const dayOrders = mData.filter(r => r[3] === fullDate);
        const hasOrder = dayOrders.length > 0;
        const cell = document.createElement('div');
        cell.className = `cal-day ${hasOrder ? 'has-order' : ''}`;
        cell.innerText = day;
        if (hasOrder) cell.onclick = () => showOrderDetail(dayOrders[0]);
        grid.appendChild(cell);
    }
}

// --- è©³æƒ…å½ˆçª—èˆ‡ App è·³è½‰ ---
function showOrderDetail(order) {
    const [id, source, name, date, type, guests, rooms, total, dep, bal] = order;
    const isBooking = source === 'Booking';
    let appLink = '';
    if(isBooking) {
        appLink = `<button class="copy-btn" style="background:#003580" onclick="location.href='bookingpulse://'">é–‹å•Ÿ Pulse App</button>`;
    } else {
        appLink = `<button class="copy-btn" style="background:#00b900" onclick="location.href='line://'">é–‹å•Ÿ LINE è¯çµ¡</button>`;
    }

    document.getElementById('modal-body').innerHTML = `
        <h3 style="margin-top:0;">${name} çš„è¨‚å–®</h3>
        <p><b>å…¥ä½æ—¥æœŸï¼š</b>${date}</p>
        <p><b>ä¾†æºï¼š</b>${source}</p>
        <p><b>äººæ•¸ï¼š</b>${guests}äºº (${type})</p>
        <p><b>è²¡å‹™ï¼š</b>ç¸½åƒ¹$${total} / è¨‚é‡‘$${dep} / å°¾æ¬¾$${bal}</p>
        <hr>${appLink}
    `;
    document.getElementById('order-modal').style.display = 'block';
}

function closeModal(e) {
    if (!e || e.target === document.getElementById('order-modal') || e.target.className === 'close-btn') {
        document.getElementById('order-modal').style.display = 'none';
    }
}

// --- çµ±è¨ˆèˆ‡è²¡å‹™ ---
function updateStatistics(mData) {
    const totalG = mData.reduce((s, r) => s + (parseInt(r[5]) || 0), 0);
    const totalR = mData.reduce((s, r) => s + (parseInt(r[6]) || 0), 0);
    const bCount = mData.filter(r => r[1] === 'Booking').length;
    const totalC = mData.length;
    document.getElementById('stat-total-guests').innerText = totalG;
    document.getElementById('stat-total-rooms').innerText = totalR;
    const bRate = totalC ? Math.round((bCount/totalC)*100) : 0;
    document.getElementById('stat-b-rate').innerText = bRate + '%';
    document.getElementById('stat-o-rate').innerText = (100 - bRate) + '%';
}

function calculateFinance(mData) {
    const mDataLocal = mData || [];
    const income = mDataLocal.reduce((s, r) => s + (parseFloat(r[7]) || 0), 0);
    const bTotal = mDataLocal.filter(r => r[1] === 'Booking').reduce((s, r) => s + (parseFloat(r[7]) || 0), 0);
    const fee = Math.round(bTotal * 0.12);
    const laundry = parseFloat(document.getElementById('laundry-cost').value) || 0;
    const utility = parseFloat(document.getElementById('utility-cost').value) || 0;
    document.getElementById('fin-income').innerText = '$' + income.toLocaleString();
    document.getElementById('fin-fee').innerText = '-$' + fee.toLocaleString();
    document.getElementById('fin-net').innerText = '$' + (income - fee - laundry - utility).toLocaleString();
}

function toggleStats() {
    const s = document.getElementById('stats-area');
    s.classList.toggle('stats-hidden');
}

function changeMonth(n) {
    currentViewDate.setMonth(currentViewDate.getMonth() + n);
    renderOrderList();
}

function copyText(id, e) {
    const t = document.getElementById(id).innerText;
    navigator.clipboard.writeText(t);
    const btn = e.currentTarget;
    const oldText = btn.innerText;
    btn.innerText = "âœ… å·²è¤‡è£½";
    setTimeout(() => btn.innerText = oldText, 1000);
}