<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>煦願民宿｜智慧工作站</title>
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="https://api.iconify.design/material-symbols:home-work-outline.svg?color=%23af6a58" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="煦願管家">
  <link rel="apple-touch-icon" href="https://api.iconify.design/material-symbols:home-work-outline.svg?color=%23af6a58">
  <meta name="theme-color" content="#af6a58"> </head>
<body>

<div id="loading-mask" class="sync-status" style="display:none;">
  <div class="spinner-small"></div>
  <span>資料同步中...</span>
</div>

<div class="container">
  <div class="nav-tabs">
    <button class="tab-btn active" onclick="switchPage('tpl-page', event)">
      <i class="fa-solid fa-message"></i> 回覆模板
    </button>
    <button class="tab-btn" onclick="switchPage('calc-page', event)">
      <i class="fa-solid fa-calculator"></i> 房價神器
    </button>
    <button class="tab-btn" onclick="switchPage('order-page', event)">
      <i class="fa-solid fa-calendar-days"></i> 所有訂單
    </button>
  </div>

  <div class="content">
    <div id="tpl-page" class="page active">
      <div class="card info-base">
        <label><i class="fa-solid fa-lightbulb"></i> 基礎資訊（填寫後自動帶入）</label>
        <div class="input-row">
          <input type="text" id="v-date" placeholder="入住日期(如3/12)" oninput="updateAll()">
          <input type="text" id="v-pwd" placeholder="今日大門密碼" oninput="updateAll()">
        </div>
        <div class="input-row">
          <input type="number" id="v-total" placeholder="總價" oninput="calculateBalance()">
          <input type="number" id="v-dep" placeholder="訂金" oninput="calculateBalance()">
        </div>
        <input type="hidden" id="v-bal">
        <div id="v-bal-display" style="font-size: 0.85rem; color: #af6a58; margin-top: 5px; padding-left: 5px; font-weight: bold;">
          自動計算尾款：$0
        </div>
      </div>

      <div class="card" id="pkg-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h3 style="margin:0; font-size: 1rem;"><i class="fa-solid fa-box-archive"></i> 已打包訊息</h3>
          <button class="cat-tag" style="background:#95a5a6; color:white; border:none; padding:4px 10px; cursor:pointer;" onclick="clearPackage()">清空</button>
        </div>
        <div class="preview-area" id="pkg-preview" contenteditable="true" style="min-height: 50px; color:#3a4553; border: 1px dashed #af6a58; background: #fff;">尚未選擇任何訊息...</div>
        <button class="copy-btn btn-pack" style="background:#af6a58;" onclick="copyText('pkg-preview', event)">複製打包訊息</button>
      </div>

      <div class="category-nav" id="cat-nav">
        <button class="cat-tag active" onclick="filterCat('all', event)">全部</button>
        <button class="cat-tag" onclick="filterCat('詢問', event)">詢問</button>
        <button class="cat-tag" onclick="filterCat('訂房', event)">訂房</button>
        <button class="cat-tag" onclick="filterCat('入住', event)">入住</button>
        <button class="cat-tag" onclick="filterCat('設施', event)">設施</button>
        <button class="cat-tag" onclick="filterCat('交通', event)">交通</button>
        <button class="cat-tag" onclick="filterCat('退房', event)">退房</button>
      </div>
      
      <div id="tpl-list"></div>
    </div>

    <div id="calc-page" class="page">
      <div class="card">
        <h3><i class="fa-solid fa-clock"></i> 1. 選擇時段</h3>
        <select id="m-season" onchange="updatePricePlaceholder();runManualCalc()">
          <option value="weekday">一般平日</option>
          <option value="weekend">週六假日</option>
          <option value="cny">農曆過年</option>
        </select>
        
        <h3 class="mt-15"><i class="fa-solid fa-bed"></i> 2. 房價與開房設定</h3>
        <div class="price-combo">
          <div class="price-row">
            <label>201</label>
            <input type="number" id="p-201" placeholder="平日價" oninput="runManualCalc()">
            <select id="m-201" onchange="runManualCalc()">
              <option value="0">不開</option>
              <option value="1">1 床</option>
            </select>
          </div>
          <div class="price-row">
            <label>202</label>
            <input type="number" id="p-202" placeholder="平日價" oninput="runManualCalc()">
            <select id="m-202" onchange="runManualCalc()">
              <option value="0">不開</option>
              <option value="1">1 床</option>
              <option value="2">2 床</option>
            </select>
          </div>
          <div class="price-row">
            <label>301</label>
            <input type="number" id="p-301" placeholder="平日價" oninput="runManualCalc()">
            <select id="m-301" onchange="runManualCalc()">
              <option value="0">不開</option>
              <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
            </select>
          </div>
        </div>
        <div id="calc-result" class="mt-15"></div>
      </div>
    </div>

    <div id="order-page" class="page">
      <div id="lock-screen" class="card">
        <h3><i class="fa-solid fa-lock"></i> 雲端資料庫連線</h3>
        <input type="password" id="admin-key" placeholder="輸入管理金鑰">
        <button class="copy-btn" style="background:#af6a58;" onclick="fetchOrders()">讀取訂單資料</button>
      </div>

      <div id="order-content" style="display:none;">
        <div class="accordion-header order-add-header" onclick="toggleAccordion('order-add-content', 'order-acc-icon')">
          <span class="acc-title"><i class="fa-solid fa-plus"></i> 快速登錄新訂單</span>
          <span id="order-acc-icon">▼</span>
        </div>
        
        <div class="accordion-content" id="order-add-content" style="display:none;">
          <input type="text" id="o-name" placeholder="訂房人姓名">
          <div class="input-row">
            <input type="date" id="o-date">
            <select id="o-source">
              <option>私LINE</option><option>Booking</option><option>官方LINE</option><option>FB</option>
            </select>
          </div>
          
          <div class="input-row">
            <div style="flex:1;"><input type="number" id="o-guests" placeholder="入住人數" style="width:100%;"></div>
            <div style="flex:1;">
              <select id="o-nights" style="width:100%;">
                <option value="" disabled selected>選擇晚數</option>
                <option value="1">1 晚</option><option value="2">2 晚</option><option value="3">3 晚</option><option value="4">4 晚</option>
              </select>
            </div>
          </div>

          <div class="input-row">
            <select id="o-rooms">
              <option value="1">1 房</option><option value="2">2 房</option><option value="3" selected>3 房 (包棟)</option>
            </select>
            <input type="number" id="o-total" placeholder="總房價">
          </div>
          <div class="input-row">
            <input type="number" id="o-dep" placeholder="訂金">
            <input type="text" id="o-note" placeholder="備註（床數、熟客等）">
          </div>
          <button class="copy-btn btn-save" style="background:#af6a58;" onclick="addOrder()">儲存並同步至雲端</button>
        </div>

        <div class="card">
          <div class="month-nav unified-nav">
            <button class="nav-arrow" onclick="changeMonth(-1)"><i class="fa-solid fa-angle-left"></i></button>
            <h3 id="cal-month-title">讀取中...</h3>
            <button class="nav-arrow" onclick="changeMonth(1)"><i class="fa-solid fa-angle-right"></i></button>
          </div>

          <div class="view-switcher">
            <button class="view-btn active" id="btn-cal" onclick="switchOrderView('cal')">月曆視圖</button>
            <button class="view-btn" id="btn-list" onclick="switchOrderView('list')">條列卡片</button>
          </div>
          
          <div id="calendar-grid" class="calendar-container"></div>
          <div id="order-list" class="mt-15" style="display:none;"></div>

    <div id="month-end-calc" style="display:none; margin-top:15px;">
        <div style="background:#f8f9fa; padding:12px; border-radius:8px; margin-bottom:15px; font-size:0.9rem; line-height:1.6;">
            <div style="display:flex; justify-content:space-between;"><span>月份：</span><strong id="me-month">--</strong></div>
            <div style="display:flex; justify-content:space-between;"><span>房費總收入：</span><strong id="me-income">$0</strong></div>
            <div style="display:flex; justify-content:space-between;"><span>Booking 12% 手續費：</span><strong id="me-fee">-$0</strong></div>
        </div>

        <div class="form-group" style="margin-bottom:10px;">
            <label style="font-size:0.85rem; color:#af6a58;">本月洗衣費支出</label>
            <input type="number" id="final-laundry" class="form-control" placeholder="請輸入金額" oninput="updateNetPreview()">
        </div>
        
        <div class="form-group" style="margin-bottom:10px;">
            <label style="font-size:0.85rem; color:#af6a58;">本月水電攤提/雜費</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="final-utility" class="form-control" placeholder="輸入或試算" oninput="updateNetPreview()">
                <button onclick="openUtilityCalc()" style="padding:0 12px; background:#3a4553; color:white; border-radius:4px; border:none; font-size:0.8rem;">試算</button>
            </div>
        </div>

        <div style="border-top:1px solid #eee; margin-top:15px; padding-top:15px; text-align:center;">
            <div style="font-size:0.8rem; color:#666;">預估本月實際淨利</div>
            <div id="me-net-preview" style="font-size:1.6rem; font-weight:bold; color:#af6a58;">$0</div>
        </div>

        <button class="copy-btn" style="width:100%; margin-top:15px; background:#3a4553;" onclick="submitMonthEnd()">
            <i class="fa-solid fa-cloud-arrow-up"></i> 確認數據，封存至雲端
        </button>
    </div>
</div>

<div id="u-modal" class="modal-overlay" style="display:none; z-index:2000;">
    <div class="modal-content" style="max-width:320px;">
        <h3 style="margin-top:0;"><i class="fa-solid fa-calculator"></i> 水電分攤器</h3>
        <label style="font-size:0.8rem;">帳單起始日</label>
        <input type="date" id="u-start" class="form-control" style="margin-bottom:10px;">
        <label style="font-size:0.8rem;">帳單結束日</label>
        <input type="date" id="u-end" class="form-control" style="margin-bottom:10px;">
        <input type="number" id="u-total" placeholder="帳單總金額" class="form-control" style="margin-bottom:15px;">
        
        <div style="background:#f4f7f6; padding:12px; border-radius:6px; font-size:0.85rem; line-height:1.6;">
            <div>本月佔用：<span id="u-days">0</span> 天</div>
            <div style="font-weight:bold; color:#af6a58;">分攤金額：$<span id="u-res">0</span></div>
        </div>
        <div class="input-row" style="margin-top:15px; gap:8px;">
            <button class="copy-btn" style="flex:1; background:#ccc;" onclick="closeUtilityCalc()">取消</button>
            <button class="copy-btn" style="flex:1; background:#af6a58;" onclick="applyUtility()">帶入</button>
        </div>
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom: 20px;">
        <i class="fa-solid fa-chart-line"></i> 經營數據統計分析
    </h3>
    
    <div class="stat-grid">
        <div class="stat-item">
            <div class="stat-label">總來客</div>
            <div class="stat-value" id="stat-total-guests">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">總開房</div>
            <div class="stat-value" id="stat-total-rooms">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Booking%</div>
            <div class="stat-value" id="stat-b-rate">0%</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">私訊%</div>
            <div class="stat-value" id="stat-o-rate">0%</div>
        </div>
    </div>

    <button class="copy-btn" onclick="openArchiveModal()" style="background: #3a4553; margin-top: 20px;">
        <i class="fa-solid fa-cloud-arrow-up"></i> 生成本月封存數據
    </button>
</div>
</div>
        <div class="card finance-card">
    <h3><i class="fa-solid fa-sack-dollar"></i> 財務月結試算</h3>
    <div class="fin-row"><span>總房費收入</span><b id="fin-income">$0</b></div>
    <div class="fin-row" style="color:#e74c3c;"><span>Booking 手續費(12%)</span><b id="fin-fee">-$0</b></div>
   <div class="fin-row">
    <span>本月洗衣費</span>
    <input type="number" id="laundry-cost" class="fin-input-standard" style="border-radius:8px;" value="0" oninput="updateNetPreview()">
</div>

<div class="fin-row">
    <span>水電攤提</span>
    <div class="input-group-custom">
        <button type="button" class="btn-calc-sm" onclick="openUtilityCalc()">試算</button>
        <input type="number" id="utility-cost" class="fin-input-standard" value="0" oninput="updateNetPreview()">
    </div>
</div>
    
    <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
    <div class="fin-row fin-total" style="font-size:1.2rem; color:#af6a58;"><span>實際淨利</span><b id="fin-net">$0</b></div>
</div>
      </div>
    </div>
  </div>
</div>

<div id="edit-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeEditModal()">&times;</span>
    <h3 id="modal-title">訂單詳細資訊</h3>
    
    <div id="info-display-view">
      <div class="info-list" id="detail-info-list"></div>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="copy-btn" style="flex:1; background:#af6a58;" onclick="toggleEditMode(true)">編輯資料</button>
        <button class="copy-btn" id="btn-pulse" style="flex:1; background:#003580;" onclick="openPulse()">Booking Pulse</button>
      </div>
    </div>

    <div id="info-edit-view" style="display:none;">
      <input type="hidden" id="e-oid">
      <input type="text" id="e-name" placeholder="姓名">
      <div class="input-row">
        <input type="date" id="e-date">
        <select id="e-nights">
          <option value="1">1 晚</option><option value="2">2 晚</option><option value="3">3 晚</option><option value="4">4 晚</option>
        </select>
      </div>
      <div class="input-row">
        <select id="e-source">
          <option>私LINE</option><option>Booking</option><option>官方LINE</option><option>FB</option>
        </select>
        <input type="number" id="e-guests" placeholder="人數">
      </div>
      <div class="input-row">
        <select id="e-rooms">
          <option value="1">1 房</option><option value="2">2 房</option><option value="3">3 房</option>
        </select>
        <input type="number" id="e-total" placeholder="總價">
      </div>
      <input type="number" id="e-dep" placeholder="訂金" style="margin-top:8px;">
      <input type="text" id="e-note" placeholder="備註" style="margin-top:8px;">
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="copy-btn" style="flex:2; background:#af6a58;" onclick="submitUpdate()">儲存更新</button>
        <button class="copy-btn" style="flex:1; background:#95a5a6;" onclick="toggleEditMode(false)">取消</button>
      </div>
      <button class="copy-btn" style="background:#e74c3c; margin-top:10px; width:100%;" onclick="submitDelete()">刪除訂單</button>
    </div>
  </div>
</div>

<div id="archive-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeArchiveModal()">&times;</span>
    <h3><i class="fa-solid fa-file-shield"></i> 本月經營數據封存確認</h3>
    
    <div class="info-list" id="archive-summary-list">
      </div>

    <div style="background: var(--primary-light); padding: 12px; border-radius: 8px; margin-top: 15px;">
      <div style="font-size: 0.8rem; color: #666; text-align: center;">預估本月實際淨利</div>
      <div id="archive-net-profit" style="font-size: 1.6rem; font-weight: bold; color: var(--primary); text-align: center;">$0</div>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="copy-btn" style="flex:1; background:#95a5a6;" onclick="closeArchiveModal()">取消</button>
      <button class="copy-btn" style="flex:2; background:#af6a58;" onclick="finalConfirmArchive()">確認封存至雲端</button>
    </div>
  </div>
</div>

<script src="script.js"></script>
</body>
</html>