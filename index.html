<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>煦願民宿｜智慧工作站</title>
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="https://api.iconify.design/material-symbols:home-work-outline.svg?color=%23af6a58" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

<div id="loading-mask" class="sync-status" style="display:none;">
  <div class="spinner-small"></div>
  <span>資料同步中...</span>
</div>

<div class="container">
  <div class="nav-tabs">
    <button class="tab-btn active" onclick="switchPage('tpl-page', event)">
      <i class="fa-solid fa-message"></i> 回覆模板
    </button>
    <button class="tab-btn" onclick="switchPage('calc-page', event)">
      <i class="fa-solid fa-calculator"></i> 房價神器
    </button>
    <button class="tab-btn" onclick="switchPage('order-page', event)">
      <i class="fa-solid fa-calendar-days"></i> 所有訂單
    </button>
  </div>

  <div class="content">
    <div id="tpl-page" class="page active">
      <div class="card info-base">
        <label><i class="fa-solid fa-lightbulb"></i> 基礎資訊（填寫後自動帶入）</label>
        <div class="input-row">
          <input type="text" id="v-date" placeholder="入住日期(如3/12)" oninput="updateAll()">
          <input type="text" id="v-pwd" placeholder="今日大門密碼" oninput="updateAll()">
        </div>
        <div class="input-row">
          <input type="number" id="v-total" placeholder="總價" oninput="calculateBalance()">
          <input type="number" id="v-dep" placeholder="訂金" oninput="calculateBalance()">
        </div>
        <div id="v-bal-display" style="font-size: 0.85rem; color: #af6a58; margin-top: 5px; font-weight: bold;">
          自動計算尾款：$0
        </div>
      </div>

      <div class="card" id="pkg-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h3 style="margin:0; font-size: 1rem;"><i class="fa-solid fa-box-archive"></i> 已打包訊息</h3>
          <button class="cat-tag" style="background:#95a5a6; color:white; border:none; padding:4px 10px;" onclick="clearPackage()">清空</button>
        </div>
        <div class="preview-area" id="pkg-preview" contenteditable="true" style="min-height: 50px; border: 1px dashed #af6a58;">尚未選擇任何訊息...</div>
        <button class="copy-btn btn-pack" style="background:#af6a58;" onclick="copyText('pkg-preview', event)">複製打包訊息</button>
      </div>

      <div class="category-nav" id="cat-nav">
        <button class="cat-tag active" onclick="filterCat('all', event)">全部</button>
        <button class="cat-tag" onclick="filterCat('詢問', event)">詢問</button>
        <button class="cat-tag" onclick="filterCat('訂房', event)">訂房</button>
        <button class="cat-tag" onclick="filterCat('入住', event)">入住</button>
        <button class="cat-tag" onclick="filterCat('設施', event)">設施</button>
        <button class="cat-tag" onclick="filterCat('交通', event)">交通</button>
        <button class="cat-tag" onclick="filterCat('退房', event)">退房</button>
      </div>
      <div id="tpl-list"></div>
    </div>

    <div id="calc-page" class="page">
      <div class="card">
        <h3><i class="fa-solid fa-clock"></i> 選擇時段</h3>
        <select id="m-season" onchange="updatePricePlaceholder();runManualCalc()">
          <option value="weekday">一般平日</option>
          <option value="weekend">週六假日</option>
          <option value="cny">農曆過年</option>
        </select>
        <div class="price-combo mt-15">
          <div class="price-row"><label>201</label><input type="number" id="p-201" oninput="runManualCalc()"><select id="m-201" onchange="runManualCalc()"><option value="0">不開</option><option value="1">1 床</option></select></div>
          <div class="price-row"><label>202</label><input type="number" id="p-202" oninput="runManualCalc()"><select id="m-202" onchange="runManualCalc()"><option value="0">不開</option><option value="1">1 床</option><option value="2">2 床</option></select></div>
          <div class="price-row"><label>301</label><input type="number" id="p-301" oninput="runManualCalc()"><select id="m-301" onchange="runManualCalc()"><option value="0">不開</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
        </div>
        <div id="calc-result" class="mt-15"></div>
      </div>
    </div>

    <div id="order-page" class="page">
      <div id="lock-screen" class="card">
        <h3><i class="fa-solid fa-lock"></i> 雲端資料庫連線</h3>
        <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">點擊下方按鈕以自動金鑰校驗並讀取資料</p>
        <input type="password" id="admin-key" placeholder="管理金鑰 (已自動化可不填)" style="display:none;">
        <button class="copy-btn" style="background:#af6a58;" onclick="fetchOrders()">連線並讀取資料</button>
      </div>

      <div id="order-content" style="display:none;">
        <div class="accordion-header" onclick="toggleAccordion('order-add-content', 'order-acc-icon')">
          <span><i class="fa-solid fa-plus"></i> 快速登錄新訂單</span>
          <span id="order-acc-icon">▼</span>
        </div>
<div class="accordion-content" id="order-add-content" style="display:none;">
    <div class="room-pill-row">
        <label><input type="checkbox" name="o-room-type" value="201"><span>201</span></label>
        <label><input type="checkbox" name="o-room-type" value="202"><span>202</span></label>
        <label><input type="checkbox" name="o-room-type" value="301"><span>301</span></label>
    </div>

    <div class="form-grid">
        <input type="date" id="o-date">
        <input type="text" id="o-name" placeholder="姓名">

        <select id="o-source">
          <option>私LINE</option><option>Booking</option><option>官方LINE</option><option>FB</option>
        </select>
        <input type="number" id="o-guests" placeholder="人數">

        <input type="number" id="o-nights" placeholder="晚數">
        <input type="number" id="o-total" placeholder="總房價">

        <input type="number" id="o-dep" placeholder="訂金">
        <input type="text" id="o-note" placeholder="備註">
    </div>

    <button class="btn-save" onclick="addOrder()">儲存並同步至雲端</button>
</div>

        <div class="card mt-15">
          <div class="month-nav unified-nav">
            <button class="nav-arrow" onclick="changeMonth(-1)"><i class="fa-solid fa-angle-left"></i></button>
            <h3 id="cal-month-title">2024年 0月</h3>
            <button class="nav-arrow" onclick="changeMonth(1)"><i class="fa-solid fa-angle-right"></i></button>
          </div>
          <div class="view-switcher">
            <button class="view-btn active" id="btn-cal" onclick="switchOrderView('cal')">月曆視圖</button>
            <button class="view-btn" id="btn-list" onclick="switchOrderView('list')">條列卡片</button>
          </div>
          <div id="calendar-grid" class="calendar-container"></div>
          <div id="order-list" class="mt-15" style="display:none;"></div>
        </div>

        <div class="card mt-15">
          <h3><i class="fa-solid fa-chart-line"></i> 經營數據統計分析</h3>
          <div class="stat-grid">
            <div class="stat-item"><div class="stat-label">總來客</div><div class="stat-value" id="stat-total-guests">0</div></div>
            <div class="stat-item"><div class="stat-label">總開房</div><div class="stat-value" id="stat-total-rooms">0</div></div>
            <div class="stat-item"><div class="stat-label">Booking%</div><div class="stat-value" id="stat-b-rate">0%</div></div>
            <div class="stat-item"><div class="stat-label">私訊%</div><div class="stat-value" id="stat-o-rate">0%</div></div>
          </div>
        </div>

        <div class="card finance-card mt-15">
          <h3><i class="fa-solid fa-sack-dollar"></i> 財務月結試算</h3>
          <div class="fin-row"><span>總房費收入</span><b id="fin-income">$0</b></div>
          <div class="fin-row" style="color:#e74c3c;"><span>Booking 手續費(12%)</span><b id="fin-fee">-$0</b></div>
          <div class="fin-row"><span>本月洗衣費</span><input type="number" id="laundry-cost" class="fin-input-standard" value="0" oninput="updateNetPreview()"></div>
          <div class="fin-row">
            <span>水電攤提</span>
            <div class="utility-row-container">
              <button type="button" class="btn-utility-calc" onclick="openUtilityModal()">試算</button>
              <input type="number" id="utility-cost" class="fin-input-utility" value="0" oninput="updateNetPreview()">
            </div>
          </div>
          <hr>
          <div class="fin-row fin-total" style="color:#af6a58;"><span>實際淨利</span><b id="archive-net-profit-preview">$0</b></div>
          <button class="copy-btn" onclick="openArchiveModal()" style="background: #3a4553; margin-top: 15px;">生成本月封存數據</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="u-modal" class="modal">
  <div class="modal-content" style="height: 85vh;">
    <span class="close-btn" onclick="closeUtilityModal()">&times;</span>
    <iframe id="utility-iframe" src="" style="width:100%; height:100%; border:none;"></iframe>
  </div>
</div>

<div id="edit-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeEditModal()">&times;</span>
    <h3 id="modal-title">訂單詳細資訊</h3>
    
    <div id="info-display-view">
      <div class="info-list" id="detail-info-list"></div>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="copy-btn" style="flex:1; background:#af6a58;" onclick="toggleEditMode(true)">編輯資料</button>
        <button class="copy-btn" id="btn-pulse" style="flex:1; background:#003580;">Booking Pulse</button>
      </div>
    </div>

   <div class="accordion-content" id="edit-content" style="display:none;">
  <input type="hidden" id="e-oid">
  <input type="text" id="e-name" placeholder="訂房人姓名" class="full-width">
  
  <div class="input-row">
    <input type="date" id="e-date">
    <select id="e-source">
      <option>私LINE</option><option>Booking</option><option>官方LINE</option><option>FB</option>
    </select>
  </div>

  <div class="input-row">
    <input type="number" id="e-guests" placeholder="人數">
    <input type="number" id="e-nights" placeholder="晚數 (手動填寫)">
  </div>

  <div class="input-row">
    <div class="room-pills">
      <label><input type="checkbox" name="e-room-type" value="201"><span>201</span></label>
      <label><input type="checkbox" name="e-room-type" value="202"><span>202</span></label>
      <label><input type="checkbox" name="e-room-type" value="301"><span>301</span></label>
    </div>
    <input type="number" id="e-total" placeholder="總房價">
  </div>

  <div class="input-row">
    <input type="number" id="e-dep" placeholder="訂金">
    <input type="text" id="e-note" placeholder="備註">
  </div>
  
  <button class="copy-btn btn-save full-width" style="background:#af6a58; margin-top:5px;" onclick="updateOrder()">
    儲存並同步到雲端
  </button>
</div>

  </div>
</div>

<div id="archive-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeArchiveModal()">&times;</span>
    <h3><i class="fa-solid fa-file-shield"></i> 本月經營數據封存確認</h3>
    <div class="info-list" id="archive-summary-list"></div>
    <div style="background: #fdf6f4; padding: 12px; border-radius: 8px; margin-top: 15px; text-align: center;">
      <div style="font-size: 0.8rem; color: #666;">預估本月實際淨利</div>
      <div id="archive-net-profit" style="font-size: 1.6rem; font-weight: bold; color: #af6a58;">$0</div>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="copy-btn" style="flex:1; background:#95a5a6;" onclick="closeArchiveModal()">取消</button>
      <button class="copy-btn" style="flex:2; background:#af6a58;" onclick="finalConfirmArchive()">確認封存至雲端</button>
    </div>
  </div>
</div>

<script src="script.js"></script>
</body>
</html>